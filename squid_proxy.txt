Task:

This ticket involves a review and lockdown of the Squid proxy (Tooling Proxy) access lists so that only connectivity to the security tools public endpoints:

CroudStrike: lfodown01-b.cloudsink.net & ts01-b.cloudsink.net
Tanium: diebold-zsb1.cloud.tanium.com & diebold-zsb2.cloud.tanium.com
 

We need to update the Puppet configuration for Squid to lock it down to this 2 URLs. on both NonLive and Live.

This should be done using the Puppet Squid module already installed: https://github.com/voxpupuli/puppet-squid.git

Code 

In Puppet hiredata i have added the following code

 ---
 # RedHat 8 Migration #################################################################################
 classes:
   - squid
  
 cloudwatchlogs::s3_source: "s3://dn.%{::region}.%{::envtype}.%{::envname}.yum/non-rpm/aws-cloudwatch-el8"
  
@@ -50,4 +52,13 @@
     type: imudp
     config:
       port: '514'
       address: '127.0.0.1'
       address: '127.0.0.1'
 
 squid::acls:
   'allowed_sites':
     type: 'dstdomain'
     entries:
       - 'lfodown01-b.cloudsink.net'
       - 'ts01-b.cloudsink.net' 
       - 'diebold-zsb1.cloud.tanium.com'
       - 'diebold-zsb2.cloud.tanium.com'

Squid conf should look like this currenly i have modified manually to test the configuration.

[root@tooling_hapee-i0d845f30f11e0fae6 manishin]# cat /etc/squid/squid.conf
#
# squid.conf.header.erb file fragment generated with puppet.
#

cache_mem                     256 MB

maximum_object_size_in_memory 512 KB


access_log                    daemon:/var/log/squid/access.log squid





# acl fragment for allowed_sites
acl allowed_sites dstdomain diebold-zsb1.cloud.tanium.com
acl allowed_sites dstdomain diebold-zsb2.cloud.tanium.com
acl allowed_sites dstdomain lfodown01-b.cloudsink.net
acl allowed_sites dstdomain ts01-b.cloudsink.net

# acl fragment for localnet
acl localnet src 10.0.0.0/8
acl localnet src 172.16.0.0/12
acl localnet src 192.168.0.0/16

# Only Allowed sites are allowed
http_access allow allowed_sites

# Deny access other than allowed sites
http_access deny !allowed_sites

# Our local host is allowed
http_access allow localhost

# Our local networks are allowed
http_access allow localnet

# Deny access to all
http_access deny all

# fragment for http_port 3128
http_port 3128

### Now i have to apply the following code in puppet hiredata how should i update it.

# acl fragment for allowed_sites
acl allowed_sites dstdomain diebold-zsb1.cloud.tanium.com
acl allowed_sites dstdomain diebold-zsb2.cloud.tanium.com
acl allowed_sites dstdomain lfodown01-b.cloudsink.net
acl allowed_sites dstdomain ts01-b.cloudsink.net

# Only Allowed sites are allowed
http_access allow allowed_sites

# Deny access other than allowed sites
http_access deny !allowed_sites

# Deny access to all
http_access deny all


Error: Evaluation Error: Error while evaluating a Method call, Class[Squid]: parameter 'http_access' expects a value of type Undef or Hash, got Tuple (file: /etc/puppetlabs/code/manifests/site.pp, line: 16, column: 37) on node tooling_hapee-i03b6a87dacda57ec4.nonlive.eu-west-1.aws.aevi.com
